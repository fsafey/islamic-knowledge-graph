name: Deploy to Netlify

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate HTML
      run: |
        echo "Validating HTML structure..."
        grep -q "<!DOCTYPE html>" index.html || (echo "Missing DOCTYPE" && exit 1)
        grep -q "charset=UTF-8" index.html || (echo "Missing charset" && exit 1)
        echo "HTML validation passed"
        
    - name: Validate ES6 modules
      run: |
        echo "Validating JavaScript modules..."
        find js/ -name "*.js" -exec node -c {} \; || (echo "JavaScript syntax error" && exit 1)
        echo "JavaScript validation passed"
        
    - name: Check file integrity
      run: |
        echo "Checking required files..."
        test -f index.html || (echo "Missing index.html" && exit 1)
        test -f js/app.js || (echo "Missing app.js" && exit 1)
        test -f css/base.css || (echo "Missing base.css" && exit 1)
        test -f imam-logo.jpg || (echo "Missing logo" && exit 1)
        echo "File integrity check passed"
        
    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.1
      with:
        publish-dir: '.'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions"
        enable-pull-request-comment: false
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      timeout-minutes: 1